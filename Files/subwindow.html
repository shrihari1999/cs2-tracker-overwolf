<!DOCTYPE html>
<html>
	<head> 
		<link rel="stylesheet" href="css/style.css" />
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
		<title>Sub window</title>
		<script>
			let db = null;
			let currentDataSource = 'tracker';

			async function initDB() {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open('CS2TrackerDB', 2);
					request.onerror = () => reject(request.error);
					request.onsuccess = () => {
						db = request.result;
						resolve(db);
					};
					request.onupgradeneeded = (event) => {
						const database = event.target.result;
						if (!database.objectStoreNames.contains('matches')) {
							const matchStore = database.createObjectStore('matches', { keyPath: 'matchId' });
							matchStore.createIndex('timestamp', 'timestamp', { unique: false });
						}
						if (!database.objectStoreNames.contains('playerMatches')) {
							const pmStore = database.createObjectStore('playerMatches', { keyPath: 'id' });
							pmStore.createIndex('playerId', 'playerId', { unique: false });
							pmStore.createIndex('playerTimestamp', ['playerId', 'timestamp'], { unique: false });
							pmStore.createIndex('matchId', 'matchId', { unique: false });
						}
						if (!database.objectStoreNames.contains('lobby')) {
							const lobbyStore = database.createObjectStore('lobby', { keyPath: 'playerId' });
							lobbyStore.createIndex('team', 'team', { unique: false });
						}
						if (!database.objectStoreNames.contains('settings')) {
							database.createObjectStore('settings', { keyPath: 'key' });
						}
					};
				});
			}

			async function getDataSource() {
				return new Promise((resolve, reject) => {
					const tx = db.transaction('settings', 'readonly');
					const store = tx.objectStore('settings');
					const request = store.get('dataSource');
					request.onsuccess = () => resolve(request.result?.value || 'tracker');
					request.onerror = () => reject(request.error);
				});
			}

			async function setDataSource(source) {
				return new Promise((resolve, reject) => {
					const tx = db.transaction('settings', 'readwrite');
					const store = tx.objectStore('settings');
					store.put({ key: 'dataSource', value: source });
					tx.oncomplete = () => resolve();
					tx.onerror = () => reject(tx.error);
				});
			}

			function dragMove(){
				overwolf.windows.getCurrentWindow(function(result){
					if (result.status=="success"){
						overwolf.windows.dragMove(result.window.id);
					}
				});
			};

			function closeWindow(){
				overwolf.windows.getCurrentWindow(function(result){
					if (result.status=="success"){
						overwolf.windows.close(result.window.id);
					}
				});
			};

			async function setSteamUserId(){
				let steamUserInputValue = document.getElementById('steam-user-input').value.trim()
				if(!steamUserInputValue){
					closeWindow();
					return
				}

				const steamIdPattern = /^7656119\d{10}$/;
				if (steamIdPattern.test(steamUserInputValue)) {
					localStorage.setItem("steamUserId", steamUserInputValue);
					await saveDataSource();
					closeWindow();
					return
				}

				const steamUrlPattern = /^https?:\/\/steamcommunity\.com\/profiles\/(7656119\d{10})\/?$/;
				const urlMatch = steamUserInputValue.match(steamUrlPattern);
				if (urlMatch) {
					localStorage.setItem("steamUserId", urlMatch[1]);
					await saveDataSource();
					closeWindow();
					return
				}

				alert('Invalid Input')
			}

			async function saveDataSource(){
				const selectedSource = document.getElementById('data-source-select').value;

				if (currentDataSource && currentDataSource !== selectedSource) {
					// Source changed - signal that a full re-sync is needed
					localStorage.setItem('dataSourceChanged', 'true');
				}
				await setDataSource(selectedSource);
			}

			document.addEventListener('DOMContentLoaded', async function(){
				await initDB();
				currentDataSource = await getDataSource();
				document.getElementById('data-source-select').value = currentDataSource;
			});
		</script>
	</head>

	<body>
		<div class="content" onmousedown="dragMove();">
			<main class="no-select">
				<h1>Steam Profile URL or ID required</h1>
				<input type="text" id="steam-user-input" placeholder="Paste here..." class="input" />
				<p>Valid inputs:</p>
				<p>76561198300127244</p>
				<p>https://steamcommunity.com/profiles/76561198300127244</p>
				<p>https://steamcommunity.com/profiles/76561198300127244/</p>

				<h2 style="margin-top: 10px;">Data Source</h2>
				<select id="data-source-select" class="input" style="width: 100%; padding: 10px;">
					<option value="tracker">tracker.gg (Recommended)</option>
					<option value="csstats">csstats.gg</option>
				</select>
				<button class="btn" onclick="setSteamUserId();">Submit</button>
				<button class="btn" onclick="closeWindow();">Cancel</button>
			</main>
		</div>
	</body>
</html>
